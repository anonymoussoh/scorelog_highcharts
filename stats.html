<!doctype html>
<html lang='ja'>
<head>
<meta charset="utf-8">
<title>Freeciv Score Viewer</title>

<script src="jquery-1.8.2.min.js" type="text/javascript"></script>
<script src="highcharts.js" type="text/javascript"></script>
<script src="exporting.js" type="text/javascript"></script>
<link rel="stylesheet" type="text/css" href="design.css">

<script type='text/javascript'>
var global_playerlist;
var global_turn;
var title_name;
function change(ev){
   $('li').removeClass('selected');
     
//   document.getElementById('graph').innerText = "";
	
	var files=ev.target.files;
	
	var file=files[0];
	if(!file)return;
	/*
    var titleelement = document.getElementById('filename');
    titleelement.childNodes.item(0).nodeValue = file.name;
    */
    title_name = file.name;
    
    var playerlist = {};
    var turn = [];
    
	var reader=new FileReader();
	reader.onload=function(e){
      var result = reader.result.split('\r\n');
      var maxline = result.length;
      var taglist = [];
      for(var currentnumber = 0; currentnumber < maxline ; currentnumber++){
       var data_strip = result[currentnumber].split(' ');
       
        if(data_strip[0] === 'addplayer'){
        playerlist[data_strip[2]] = {'name' : data_strip[3]};
        }
        
        if(data_strip[0] === 'tag'){
        taglist.push(data_strip[2]);
        }
        
        if(data_strip[0] === 'turn'){
        turn.push(data_strip[1]);
        }
        
        if(data_strip[0] === 'data'){
         var taglist_length = taglist.length;
          for(var current_tag = 0; current_tag < taglist_length; current_tag++){
           if(data_strip[2] == current_tag){
            if(!playerlist[data_strip[3]][taglist[current_tag]]){
            playerlist[data_strip[3]][taglist[current_tag]] = {};
            }
           playerlist[data_strip[3]][taglist[current_tag]][data_strip[1]] = parseInt(data_strip[4]);
           }
          }
        }
        
      }
    var lastturn = turn.length;
    for(var current_player_pos in playerlist){
     for(var current_tag_name in playerlist[current_player_pos]){
      if(current_tag_name === 'name'){
      continue;
      }
     var array = [];
      for(var current_turn = 0; current_turn < lastturn; current_turn++){
       if(!playerlist[current_player_pos][current_tag_name][current_turn]){
       playerlist[current_player_pos][current_tag_name][current_turn] = 0;
       }
      array.push(playerlist[current_player_pos][current_tag_name][current_turn]);
     }
     playerlist[current_player_pos][current_tag_name] = array;
     }
    }
   };
 global_playerlist = playerlist;
 global_turn = turn;
	reader.readAsText(file);
}

</script>

</head>
<body lang='ja'>

<!--<h2 id='filename'>title</h2>-->
<div id='frame'>
<div id='file_selecter'>
<span id='title'>Freeciv Score Viewer</span>
<input type="file" onchange="change(event)">｜←こちらからファイルを選択してください。
</div>
 <div id='listbox'>
  <ul>
   <li>総人口</li>
   <li>BNP</li>
   <li>生産力</li>
   <li>都市数</li>
   <li>科学技術</li>
   <li>保有ユニット</li>
   <li>開拓者</li>
   <li>不思議</li>
   <li>研究速度</li>
   <li>国土面積</li>
   <li>入植面積</li>
   <li>公害</li>
   <li>読み書き</li>
   <li>宇宙船</li>
   <li>国庫金</li>
   <li>税</li>
   <li>科学</li>
   <li>贅沢</li>
   <li>混乱</li>
   <li>幸福市民</li>
   <li>平静市民</li>
   <li>不幸市民</li>
   <li>専門家</li>
   <li>政治体制</li>
   <li>汚職</li>
   <li>スコア</li>
   <li>総製造数</li>
   <li>総撃破数</li>
   <li>総被撃破数</li>
  </ul>
 </div>
 <div id='graph'>
 
 </div>
</div>
<p id='float_clear'>
Copyright Soh 2012 Some rights reserved.
</p>
</body>
</html>
<script type="text/javascript">

var chart1; // globally available

$('li').click(function() {
     $('li').removeClass('selected');
     $(this).addClass('selected');
      if(title_name === undefined){
      return;
      }
     var playerdata = global_playerlist;
     var taglist = ["pop", "bnp", "mfg", "cities", "techs", "munits", "settlers", "wonders", "techout", "landarea", "settledarea", "pollution", "literacy", "spaceship", "gold", "taxrate", "scirate", "luxrate", "riots", "happypop", "contentpop", "unhappypop", "specialists", "gov", "corruption", "score", "unitsbuilt", "unitskilled", "unitslost"];
     var turn = global_turn;

     var dataseries = [];
     var target = taglist[$('li').index(this)];
       for(var item in playerdata){
       var temp = {};
       temp.name = playerdata[item]['name'];
       temp.data = playerdata[item][target];
       dataseries.push(temp);
       }
      chart1 = new Highcharts.Chart({
         chart: {
            height : 20 * $('li').length + 1,
            borderColor:'gray',
            borderWidth:1,
            borderRadius:0,
            renderTo: 'graph',
            type: 'line',
            zoomType:'xy',
            backgroundColor:'#FFFFFF'
         },
         title: {
            text: title_name + ' : ' + $(this).text()
         },
         plotOptions:{
          line:{
           lineWidth: 2,
           marker: {
                    enabled : false
                    }
          }
         },
         xAxis: {
            tickInterval : 20,
            categories: turn
         },
         yAxis:
         {
            title: {
               text: 'Score'
            },
            min:0
         },
         series: dataseries
         }
       );
   });
</script>